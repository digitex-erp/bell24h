<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Bell24h</title>
    
    <!-- Import Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Custom styles -->
    <style>
        .message-bubble-sent {
            background-color: #E9F5FF;
            border-radius: 18px 18px 4px 18px;
        }
        
        .message-bubble-received {
            background-color: #F5F5F5;
            border-radius: 18px 18px 18px 4px;
        }
        
        .thread-item {
            transition: all 0.2s ease;
        }
        
        .thread-item:hover, .thread-item.active {
            background-color: #F0F7FF;
        }
        
        .thread-item.unread {
            background-color: #F0F7FF;
            border-left: 3px solid #3B82F6;
        }
        
        .attachment-preview {
            max-width: 150px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }

        .message-input {
            min-height: 20px;
            max-height: 120px;
        }

        /* Custom scrollbar for threads */
        .thread-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .thread-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .thread-list::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
        
        .thread-list::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
        
        /* Custom scrollbar for messages */
        .message-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .message-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .message-container::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
        
        .message-container::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <!-- Logo -->
                <div class="flex items-center space-x-2">
                    <img src="logo.png" alt="Bell24h Logo" class="h-8">
                    <span class="text-2xl font-bold text-blue-600">Bell24h</span>
                </div>
                
                <!-- Main Navigation -->
                <nav class="hidden md:flex space-x-6">
                    <a href="index.html" class="text-gray-600 hover:text-blue-600">Dashboard</a>
                    <a href="rfq-list.html" class="text-gray-600 hover:text-blue-600">RFQs</a>
                    <a href="suppliers.html" class="text-gray-600 hover:text-blue-600">Suppliers</a>
                    <a href="industry-trends.html" class="text-gray-600 hover:text-blue-600">Industry Trends</a>
                    <a href="messages.html" class="text-blue-600 font-medium">Messages</a>
                </nav>
                
                <!-- Right side menu -->
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button class="text-gray-500 hover:text-blue-600">
                            <i class="fas fa-bell text-lg"></i>
                            <span class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-xs flex items-center justify-center">3</span>
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="User" class="w-8 h-8 rounded-full">
                        <span class="text-gray-700 hidden md:inline">John Smith</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-md flex h-[calc(100vh-8rem)] overflow-hidden">
            <!-- Thread list -->
            <div class="w-full sm:w-80 lg:w-96 border-r border-gray-200 flex flex-col">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">Messages</h2>
                    <div class="mt-3 relative">
                        <input type="text" placeholder="Search messages..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button id="new-message-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <i class="fas fa-pen-to-square mr-2"></i>New Message
                        </button>
                    </div>
                </div>
                
                <div class="overflow-y-auto thread-list flex-grow">
                    <div id="thread-list" class="divide-y divide-gray-200">
                        <!-- Thread items will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Message view -->
            <div class="hidden sm:flex flex-col flex-grow">
                <!-- Empty state -->
                <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center p-6">
                    <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-comments text-4xl text-blue-500"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Your Messages</h3>
                    <p class="text-gray-500 max-w-md">Select a conversation to view messages or start a new conversation with suppliers and buyers</p>
                    <button id="empty-new-message-btn" class="mt-6 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <i class="fas fa-pen-to-square mr-2"></i>Start New Conversation
                    </button>
                </div>
                
                <!-- Message container -->
                <div id="message-container" class="flex-col flex-grow hidden">
                    <!-- Thread header -->
                    <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <img id="thread-avatar" src="https://randomuser.me/api/portraits/men/44.jpg" alt="Thread" class="w-10 h-10 rounded-full">
                            </div>
                            <div class="ml-3">
                                <h3 id="thread-title" class="text-lg font-semibold text-gray-800">RFQ #1234 - Industrial Supplies</h3>
                                <div id="thread-participants" class="text-sm text-gray-500">3 participants</div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="text-gray-500 hover:text-blue-600 p-2" title="Add Participants">
                                <i class="fas fa-user-plus"></i>
                            </button>
                            <button class="text-gray-500 hover:text-blue-600 p-2" title="Thread Information">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Messages -->
                    <div id="messages-list" class="flex-grow overflow-y-auto message-container p-4 space-y-4">
                        <!-- Messages will be populated here -->
                    </div>
                    
                    <!-- Message input -->
                    <div class="p-4 border-t border-gray-200 bg-white">
                        <form id="message-form" class="flex flex-col space-y-2">
                            <div class="flex-grow relative bg-gray-100 rounded-lg p-2 pr-12">
                                <div contenteditable="true" id="message-input" class="message-input outline-none w-full overflow-auto p-2" placeholder="Type a message..."></div>
                                <div class="absolute right-3 bottom-3 flex space-x-2">
                                    <button type="button" id="attach-button" class="text-gray-500 hover:text-blue-600">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div id="attachment-preview" class="hidden border rounded-lg p-2 bg-gray-50">
                                <div class="flex items-center">
                                    <div class="flex-grow overflow-hidden">
                                        <div id="attachment-name" class="truncate text-sm">document.pdf</div>
                                    </div>
                                    <button type="button" id="remove-attachment" class="text-red-500 hover:text-red-700 pl-2">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex justify-end">
                                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    <i class="fas fa-paper-plane mr-2"></i>Send
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- New Message Modal -->
    <div id="new-message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg w-full max-w-2xl p-6 shadow-xl">
            <div class="flex justify-between items-center border-b border-gray-200 pb-4">
                <h3 class="text-xl font-semibold text-gray-800">New Conversation</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="new-thread-form" class="mt-6 space-y-4">
                <div>
                    <label for="thread-title" class="block text-sm font-medium text-gray-700 mb-1">Conversation Title</label>
                    <input type="text" id="thread-title-input" name="thread-title" placeholder="E.g., RFQ Discussion or Contract Negotiation" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Related to (Optional)</label>
                    <div class="flex space-x-4 mb-2">
                        <div class="flex items-center">
                            <input type="radio" id="rfq-radio" name="related-type" value="rfq" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="rfq-radio" class="ml-2 text-sm text-gray-700">RFQ</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="bid-radio" name="related-type" value="bid" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="bid-radio" class="ml-2 text-sm text-gray-700">Bid</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="contract-radio" name="related-type" value="contract" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="contract-radio" class="ml-2 text-sm text-gray-700">Contract</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="none-radio" name="related-type" value="none" class="h-4 w-4 text-blue-600 focus:ring-blue-500" checked>
                            <label for="none-radio" class="ml-2 text-sm text-gray-700">None</label>
                        </div>
                    </div>
                    
                    <div id="related-id-container" class="hidden">
                        <select id="related-id-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select...</option>
                            <!-- Options will be populated dynamically based on selection -->
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="participants" class="block text-sm font-medium text-gray-700 mb-1">Participants</label>
                    <div class="relative">
                        <input type="text" id="participant-search" placeholder="Search users..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <div id="participant-results" class="absolute w-full mt-1 max-h-60 overflow-y-auto bg-white border border-gray-300 rounded-lg shadow-lg z-10 hidden">
                            <!-- Search results will appear here -->
                        </div>
                    </div>
                    
                    <div id="selected-participants" class="mt-3 flex flex-wrap gap-2">
                        <!-- Selected participants will appear here -->
                    </div>
                </div>
                
                <div>
                    <label for="initial-message" class="block text-sm font-medium text-gray-700 mb-1">Initial Message</label>
                    <textarea id="initial-message" rows="3" placeholder="Type your first message here..."
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" id="cancel-new-thread" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Create Conversation
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Hidden file input -->
    <input type="file" id="file-input" class="hidden" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.zip">
    
    <script>
        // Current user ID (would come from authentication)
        const currentUserId = 1;
        let currentThreadId = null;
        let selectedParticipants = [];
        let messageAttachment = null;
        let socket = null; // WebSocket connection
        
        // DOM references
        const threadList = document.getElementById('thread-list');
        const messagesList = document.getElementById('messages-list');
        const emptyState = document.getElementById('empty-state');
        const messageContainer = document.getElementById('message-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const attachButton = document.getElementById('attach-button');
        const fileInput = document.getElementById('file-input');
        const attachmentPreview = document.getElementById('attachment-preview');
        const attachmentName = document.getElementById('attachment-name');
        const removeAttachment = document.getElementById('remove-attachment');
        
        // New message modal elements
        const newMessageBtn = document.getElementById('new-message-btn');
        const emptyNewMessageBtn = document.getElementById('empty-new-message-btn');
        const newMessageModal = document.getElementById('new-message-modal');
        const closeModal = document.getElementById('close-modal');
        const cancelNewThread = document.getElementById('cancel-new-thread');
        const newThreadForm = document.getElementById('new-thread-form');
        const threadTitleInput = document.getElementById('thread-title-input');
        const initialMessage = document.getElementById('initial-message');
        const participantSearch = document.getElementById('participant-search');
        const participantResults = document.getElementById('participant-results');
        const selectedParticipantsContainer = document.getElementById('selected-participants');
        
        // Related item elements
        const relatedTypeRadios = document.getElementsByName('related-type');
        const relatedIdContainer = document.getElementById('related-id-container');
        const relatedIdSelect = document.getElementById('related-id-select');
        
        // Event listeners for new message modal
        newMessageBtn.addEventListener('click', openNewMessageModal);
        emptyNewMessageBtn.addEventListener('click', openNewMessageModal);
        closeModal.addEventListener('click', closeNewMessageModal);
        cancelNewThread.addEventListener('click', closeNewMessageModal);
        
        // Handle radio button change for related items
        relatedTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'none') {
                    relatedIdContainer.classList.add('hidden');
                } else {
                    relatedIdContainer.classList.remove('hidden');
                    fetchRelatedItems(this.value);
                }
            });
        });
        
        // Handle participant search
        participantSearch.addEventListener('input', function() {
            const query = this.value.trim();
            if (query.length >= 2) {
                fetchUsers(query);
            } else {
                participantResults.classList.add('hidden');
            }
        });
        
        // Handle new thread form submission
        newThreadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            createNewThread();
        });
        
        // Handle message form submission
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });
        
        // Handle file attachment
        attachButton.addEventListener('click', function() {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                messageAttachment = this.files[0];
                attachmentName.textContent = messageAttachment.name;
                attachmentPreview.classList.remove('hidden');
            }
        });
        
        removeAttachment.addEventListener('click', function() {
            messageAttachment = null;
            fileInput.value = '';
            attachmentPreview.classList.add('hidden');
        });
        
        // Initialize WebSocket connection
        initWebSocket();
        
        // Initialize
        fetchThreads();
        
        // Functions
        function openNewMessageModal() {
            newMessageModal.classList.remove('hidden');
            threadTitleInput.focus();
        }
        
        function closeNewMessageModal() {
            newMessageModal.classList.add('hidden');
            newThreadForm.reset();
            selectedParticipants = [];
            selectedParticipantsContainer.innerHTML = '';
            relatedIdContainer.classList.add('hidden');
        }
        
        function fetchThreads() {
            // Fetch user's message threads from API
            fetch(`/api/users/${currentUserId}/message-threads`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch threads');
                    }
                    return response.json();
                })
                .then(threads => {
                    displayThreads(threads);
                })
                .catch(error => {
                    console.error('Error fetching threads:', error);
                    
                    // For demo: Show sample threads if fetch fails
                    const sampleThreads = getSampleThreads();
                    displayThreads(sampleThreads);
                });
        }
        
        function displayThreads(threads) {
            threadList.innerHTML = '';
            
            if (threads.length === 0) {
                threadList.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        No conversations yet. Start a new one!
                    </div>
                `;
                return;
            }
            
            threads.forEach(thread => {
                const threadEl = document.createElement('div');
                threadEl.className = `thread-item p-4 cursor-pointer ${thread.unread_count > 0 ? 'unread' : ''}`;
                threadEl.setAttribute('data-thread-id', thread.id);
                
                // Get participant avatar or use default
                const avatarSrc = thread.avatar || 'https://randomuser.me/api/portraits/men/44.jpg';
                
                // Format date for display
                const lastActivity = new Date(thread.last_activity || thread.updated_at);
                const timeAgo = formatTimeAgo(lastActivity);
                
                threadEl.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <img src="${avatarSrc}" alt="Thread" class="w-12 h-12 rounded-full">
                        </div>
                        <div class="ml-3 flex-grow">
                            <div class="flex justify-between items-start">
                                <h4 class="text-base font-medium text-gray-900 truncate">${thread.title}</h4>
                                <span class="text-xs text-gray-500">${timeAgo}</span>
                            </div>
                            <p class="text-sm text-gray-600 truncate">
                                ${thread.last_message || 'Start the conversation...'}
                            </p>
                        </div>
                    </div>
                    ${thread.unread_count > 0 ? 
                        `<div class="flex justify-end mt-1">
                            <span class="bg-blue-500 text-white text-xs font-semibold px-2 py-0.5 rounded-full">
                                ${thread.unread_count} new
                            </span>
                        </div>` : ''}
                `;
                
                threadEl.addEventListener('click', () => openThread(thread.id));
                threadList.appendChild(threadEl);
            });
        }
        
        function openThread(threadId) {
            // Remove active class from all threads
            document.querySelectorAll('.thread-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected thread
            const threadEl = document.querySelector(`.thread-item[data-thread-id="${threadId}"]`);
            if (threadEl) {
                threadEl.classList.add('active');
                // Remove unread class
                threadEl.classList.remove('unread');
            }
            
            currentThreadId = threadId;
            
            // Hide empty state and show message container
            emptyState.classList.add('hidden');
            messageContainer.classList.remove('hidden');
            messageContainer.classList.add('flex');
            
            // Fetch thread details and messages
            fetch(`/api/message-threads/${threadId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch thread details');
                    }
                    return response.json();
                })
                .then(data => {
                    displayThreadDetails(data.thread, data.participants);
                    
                    // Store thread data for later reference
                    document.querySelector(`.thread-item[data-thread-id="${threadId}"]`).__threadData = data;
                    
                    // Mark thread as read via WebSocket if connected
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            type: 'mark_read',
                            threadId: threadId
                        }));
                    }
                    
                    // Now fetch messages
                    return fetch(`/api/message-threads/${threadId}/messages?userId=${currentUserId}`);
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch messages');
                    }
                    return response.json();
                })
                .then(messages => {
                    displayMessages(messages);
                })
                .catch(error => {
                    console.error('Error opening thread:', error);
                    
                    // For demo: Show sample thread details and messages if fetch fails
                    const sampleThreadData = getSampleThreadData(threadId);
                    displayThreadDetails(sampleThreadData.thread, sampleThreadData.participants);
                    displayMessages(sampleThreadData.messages);
                });
        }
        
        function displayThreadDetails(thread, participants) {
            document.getElementById('thread-title').textContent = thread.title;
            document.getElementById('thread-participants').textContent = `${participants.length} participant${participants.length !== 1 ? 's' : ''}`;
            
            // For simplicity, just use a random avatar for now
            // In a real app, you might want to show multiple avatars or use thread avatar
            document.getElementById('thread-avatar').src = 'https://randomuser.me/api/portraits/men/44.jpg';
        }
        
        function displayMessages(messages) {
            messagesList.innerHTML = '';
            
            if (messages.length === 0) {
                messagesList.innerHTML = `
                    <div class="text-center p-6 text-gray-500">
                        No messages yet. Start the conversation!
                    </div>
                `;
                return;
            }
            
            // Group messages by date
            const groupedMessages = groupMessagesByDate(messages);
            
            // Iterate through grouped messages
            Object.entries(groupedMessages).forEach(([date, msgs]) => {
                // Add date separator
                const dateElement = document.createElement('div');
                dateElement.className = 'flex items-center justify-center my-6';
                dateElement.innerHTML = `
                    <div class="bg-gray-200 text-gray-600 text-xs font-medium px-3 py-1 rounded-full">
                        ${formatMessageDate(date)}
                    </div>
                `;
                messagesList.appendChild(dateElement);
                
                // Add messages for this date
                msgs.forEach(message => {
                    const isSent = message.sender_id == currentUserId;
                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${isSent ? 'sent ml-auto max-w-[80%]' : 'received max-w-[80%]'}`;
                    
                    // HTML for the message
                    let messageHTML = `
                        <div class="flex ${isSent ? 'justify-end' : 'items-start'}">
                            ${!isSent ? `
                                <img src="${message.profile_picture || 'https://randomuser.me/api/portraits/men/32.jpg'}" alt="Sender" class="w-8 h-8 rounded-full mr-2">
                            ` : ''}
                            <div>
                                ${!isSent ? `<div class="text-xs text-gray-500 mb-1">${message.username || 'User ' + message.sender_id}</div>` : ''}
                                <div class="${isSent ? 'message-bubble-sent' : 'message-bubble-received'} p-3">
                                    <div class="text-sm">${formatMessageContent(message.content)}</div>
                                    ${message.attachment_url ? `
                                        <div class="mt-2">
                                            <a href="${message.attachment_url}" target="_blank" class="text-blue-600 text-xs flex items-center">
                                                <i class="fas fa-paperclip mr-1"></i>
                                                ${getAttachmentName(message.attachment_url)}
                                            </a>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-xs text-gray-500 mt-1 ${isSent ? 'text-right' : ''}">${formatMessageTime(message.created_at)}</div>
                            </div>
                        </div>
                    `;
                    
                    messageEl.innerHTML = messageHTML;
                    messagesList.appendChild(messageEl);
                });
            });
            
            // Scroll to bottom
            messagesList.scrollTop = messagesList.scrollHeight;
        }
        
        // Initialize WebSocket connection
        function initWebSocket() {
            // Create WebSocket connection
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                console.log('WebSocket connection established');
                
                // Authenticate WebSocket connection
                socket.send(JSON.stringify({
                    type: 'auth',
                    userId: currentUserId
                }));
            };
            
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('WebSocket message received:', data);
                    
                    // Handle different message types
                    switch(data.type) {
                        case 'new_message':
                            // Add new message to UI if it's for the current thread
                            if (data.threadId === currentThreadId) {
                                const message = data.message;
                                const messages = document.querySelectorAll('.message');
                                const existingMessages = [...messages].map(msgEl => msgEl.__message || {});
                                displayMessages([...existingMessages, message]);
                            }
                            
                            // Update thread in the list
                            updateThreadInList(data.threadId, data.message.content);
                            
                            // Refresh threads list to update unread count
                            fetchThreads();
                            break;
                            
                        case 'unread_count':
                            // Update unread count in UI
                            console.log('Unread count updated:', data.count);
                            // You could update a badge or notification icon here
                            break;
                            
                        case 'error':
                            console.error('WebSocket error:', data.message);
                            break;
                            
                        default:
                            console.log('Unknown message type:', data.type);
                    }
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            socket.onclose = function() {
                console.log('WebSocket connection closed');
                // Try to reconnect after a delay
                setTimeout(initWebSocket, 3000);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }
        
        function sendMessage() {
            const content = messageInput.innerText.trim();
            
            if (!content && !messageAttachment) {
                return; // Don't send empty messages
            }
            
            // Create FormData for message with possible attachment
            const formData = new FormData();
            formData.append('sender_id', currentUserId);
            formData.append('content', content);
            
            if (messageAttachment) {
                formData.append('attachment', messageAttachment);
            }
            
            // Clear input and attachment
            messageInput.innerText = '';
            messageAttachment = null;
            fileInput.value = '';
            attachmentPreview.classList.add('hidden');
            
            // Determine recipient ID
            const recipientId = document.querySelector(`.thread-item[data-thread-id="${currentThreadId}"]`)?.__threadData?.participants?.[0]?.user_id || 1;
            
            // If WebSocket is connected, send message through WebSocket
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'send_message',
                    message: {
                        threadId: currentThreadId,
                        recipientId: recipientId,
                        content: content,
                        attachmentUrl: null
                    }
                }));
                
                // If we have an attachment, still need to send it through regular API
                if (messageAttachment) {
                    // Send attachment through regular API
                    fetch(`/api/message-threads/${currentThreadId}/messages`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .catch(error => console.error('Error sending attachment:', error));
                }
                
                // Create temporary message for UI
                const now = new Date().toISOString();
                const tempMessage = {
                    id: Date.now(),
                    sender_id: currentUserId,
                    thread_id: currentThreadId,
                    content: content,
                    created_at: now,
                    is_read: true
                };
                
                // Update UI immediately without waiting for server response
                const messages = document.querySelectorAll('.message');
                const existingMessages = [...messages].map(msgEl => msgEl.__message || {});
                displayMessages([...existingMessages, tempMessage]);
                
                // Update thread in the list
                updateThreadInList(currentThreadId, content);
                
                return;
            }
            
            // Fallback to regular API if WebSocket is not connected
            fetch(`/api/message-threads/${currentThreadId}/messages`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to send message');
                }
                return response.json();
            })
            .then(message => {
                // Add message to the UI
                const messages = [message];
                displayMessages([...document.querySelectorAll('.message')].map(msgEl => msgEl.__message || {}).concat(messages));
                
                // Update thread in the list
                updateThreadInList(currentThreadId, content);
            })
            .catch(error => {
                console.error('Error sending message:', error);
                
                // For demo: Show the message anyway
                const now = new Date().toISOString();
                const fakeMessage = {
                    id: Date.now(),
                    sender_id: currentUserId,
                    thread_id: currentThreadId,
                    content: content,
                    created_at: now,
                    updated_at: now,
                    is_read: true,
                    attachment_url: messageAttachment ? URL.createObjectURL(messageAttachment) : null
                };
                
                const messages = document.querySelectorAll('.message');
                const existingMessages = [...messages].map(msgEl => msgEl.__message || {});
                displayMessages([...existingMessages, fakeMessage]);
                
                // Update thread in the list
                updateThreadInList(currentThreadId, content);
            });
        }
        
        function updateThreadInList(threadId, lastMessage) {
            const threadEl = document.querySelector(`.thread-item[data-thread-id="${threadId}"]`);
            if (threadEl) {
                // Update last message preview
                const msgPreview = threadEl.querySelector('p');
                if (msgPreview) {
                    msgPreview.textContent = lastMessage || 'Attachment';
                }
                
                // Update timestamp
                const timestamp = threadEl.querySelector('.text-xs.text-gray-500');
                if (timestamp) {
                    timestamp.textContent = 'Just now';
                }
                
                // Move thread to top of list
                threadList.insertBefore(threadEl, threadList.firstChild);
            }
        }
        
        function createNewThread() {
            const title = threadTitleInput.value.trim();
            const message = initialMessage.value.trim();
            
            if (!title || selectedParticipants.length === 0 || !message) {
                alert('Please fill out all required fields and select at least one participant');
                return;
            }
            
            // Get related item ID if any
            let rfqId = null;
            const relatedType = document.querySelector('input[name="related-type"]:checked').value;
            if (relatedType !== 'none') {
                rfqId = relatedIdSelect.value;
            }
            
            // Build request data
            const requestData = {
                title: title,
                rfq_id: rfqId,
                participants: selectedParticipants.map(p => p.id),
                user_id: currentUserId // Current user creating the thread
            };
            
            // Create thread
            fetch('/api/message-threads', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to create thread');
                }
                return response.json();
            })
            .then(data => {
                // Thread created, now send initial message
                return fetch(`/api/message-threads/${data.thread.id}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sender_id: currentUserId,
                        content: message
                    })
                });
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to send initial message');
                }
                
                // Close modal and fetch updated thread list
                closeNewMessageModal();
                fetchThreads();
            })
            .catch(error => {
                console.error('Error creating thread:', error);
                
                // For demo: Create fake thread locally
                closeNewMessageModal();
                
                const now = new Date().toISOString();
                const newThreadId = Date.now();
                
                const newThread = {
                    id: newThreadId,
                    title: title,
                    rfq_id: rfqId,
                    created_by: currentUserId,
                    created_at: now,
                    updated_at: now,
                    last_activity: now,
                    unread_count: 0,
                    last_message: message
                };
                
                // Add thread to list
                const demoThreads = getSampleThreads();
                demoThreads.unshift(newThread);
                displayThreads(demoThreads);
                
                // Open the new thread
                setTimeout(() => {
                    openThread(newThreadId);
                }, 100);
            });
        }
        
        function fetchRelatedItems(type) {
            relatedIdSelect.innerHTML = '<option value="">Select...</option>';
            
            // Fetch RFQs/contracts/bids from API
            fetch(`/api/users/${currentUserId}/${type}s`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch ${type}s`);
                    }
                    return response.json();
                })
                .then(items => {
                    displayRelatedItems(items, type);
                })
                .catch(error => {
                    console.error(`Error fetching ${type}s:`, error);
                    
                    // For demo: Show sample items if fetch fails
                    const sampleItems = getSampleRelatedItems(type);
                    displayRelatedItems(sampleItems, type);
                });
        }
        
        function displayRelatedItems(items, type) {
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                
                // Customize display text based on type
                switch(type) {
                    case 'rfq':
                        option.textContent = `${item.reference_number || `RFQ-${item.id}`} - ${item.title || 'Untitled RFQ'}`;
                        break;
                    case 'bid':
                        option.textContent = `Bid #${item.id} - ${item.amount ? `$${item.amount}` : 'No amount'} - ${item.status || 'Pending'}`;
                        break;
                    case 'contract':
                        option.textContent = `Contract #${item.id} - ${item.title || 'Untitled Contract'}`;
                        break;
                    default:
                        option.textContent = `Item #${item.id}`;
                }
                
                relatedIdSelect.appendChild(option);
            });
        }
        
        function fetchUsers(query) {
            // Fetch users matching query from API
            fetch(`/api/users/search?q=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch users');
                    }
                    return response.json();
                })
                .then(users => {
                    displayUserResults(users);
                })
                .catch(error => {
                    console.error('Error fetching users:', error);
                    
                    // For demo: Show sample users if fetch fails
                    const sampleUsers = getSampleUsers(query);
                    displayUserResults(sampleUsers);
                });
        }
        
        function displayUserResults(users) {
            participantResults.innerHTML = '';
            
            if (users.length === 0) {
                participantResults.innerHTML = `
                    <div class="p-3 text-center text-gray-500">
                        No users found
                    </div>
                `;
                participantResults.classList.remove('hidden');
                return;
            }
            
            users.forEach(user => {
                // Skip already selected users
                if (selectedParticipants.some(p => p.id === user.id)) {
                    return;
                }
                
                const userEl = document.createElement('div');
                userEl.className = 'p-3 hover:bg-gray-100 cursor-pointer flex items-center';
                
                userEl.innerHTML = `
                    <img src="${user.profile_picture || 'https://randomuser.me/api/portraits/men/32.jpg'}" alt="${user.username}" class="w-8 h-8 rounded-full mr-2">
                    <div>
                        <div class="font-medium">${user.first_name} ${user.last_name}</div>
                        <div class="text-xs text-gray-500">${user.email || user.username}</div>
                    </div>
                `;
                
                userEl.addEventListener('click', () => {
                    addParticipant(user);
                    participantResults.classList.add('hidden');
                    participantSearch.value = '';
                });
                
                participantResults.appendChild(userEl);
            });
            
            participantResults.classList.remove('hidden');
        }
        
        function addParticipant(user) {
            // Check if already added
            if (selectedParticipants.some(p => p.id === user.id)) {
                return;
            }
            
            selectedParticipants.push(user);
            
            const participantEl = document.createElement('div');
            participantEl.className = 'bg-blue-100 rounded-full py-1 px-3 flex items-center';
            participantEl.innerHTML = `
                <span class="text-sm text-blue-800">${user.first_name || user.username}</span>
                <button type="button" class="ml-1 text-blue-500 hover:text-blue-700" data-user-id="${user.id}">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;
            
            // Add remove button event
            participantEl.querySelector('button').addEventListener('click', () => {
                removeParticipant(user.id);
                participantEl.remove();
            });
            
            selectedParticipantsContainer.appendChild(participantEl);
        }
        
        function removeParticipant(userId) {
            selectedParticipants = selectedParticipants.filter(p => p.id !== userId);
        }
        
        // Helper functions
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffSecs < 60) {
                return 'Just now';
            } else if (diffMins < 60) {
                return `${diffMins}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else if (diffDays < 7) {
                return `${diffDays}d ago`;
            } else {
                return date.toLocaleDateString();
            }
        }
        
        function formatMessageTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function formatMessageDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString();
            }
        }
        
        function formatMessageContent(content) {
            // Replace URLs with clickable links
            return content.replace(
                /(https?:\/\/[^\s]+)/g, 
                '<a href="$1" target="_blank" class="text-blue-600 underline">$1</a>'
            );
        }
        
        function getAttachmentName(url) {
            // Extract filename from URL
            const parts = url.split('/');
            return parts[parts.length - 1];
        }
        
        function groupMessagesByDate(messages) {
            const grouped = {};
            
            messages.forEach(message => {
                const date = new Date(message.created_at).toDateString();
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(message);
            });
            
            return grouped;
        }
        
        // Sample data for demo purposes
        function getSampleThreads() {
            return [
                {
                    id: 1,
                    title: "RFQ #1234 - Industrial Supplies",
                    rfq_id: 1234,
                    created_by: 2,
                    created_at: "2025-05-02T10:30:00Z",
                    updated_at: "2025-05-03T14:15:00Z",
                    last_activity: "2025-05-03T14:15:00Z",
                    unread_count: 3,
                    last_message: "When can we expect delivery of the samples?"
                },
                {
                    id: 2,
                    title: "Contract #789 - Component Sourcing",
                    rfq_id: null,
                    created_by: 1,
                    created_at: "2025-05-01T09:45:00Z",
                    updated_at: "2025-05-03T11:20:00Z",
                    last_activity: "2025-05-03T11:20:00Z",
                    unread_count: 0,
                    last_message: "The contract has been updated with the new terms."
                },
                {
                    id: 3,
                    title: "Electronics Supplier Discussion",
                    rfq_id: null,
                    created_by: 3,
                    created_at: "2025-04-29T16:10:00Z",
                    updated_at: "2025-05-01T08:30:00Z",
                    last_activity: "2025-05-01T08:30:00Z",
                    unread_count: 0,
                    last_message: "We can provide the components at a competitive price."
                }
            ];
        }
        
        function getSampleThreadData(threadId) {
            // Sample thread details and messages for demonstration
            const threadDetails = {
                thread: {
                    id: threadId,
                    title: "RFQ #1234 - Industrial Supplies",
                    rfq_id: 1234,
                    created_by: 2,
                    created_at: "2025-05-02T10:30:00Z",
                    updated_at: "2025-05-03T14:15:00Z"
                },
                participants: [
                    {
                        id: 1,
                        thread_id: threadId,
                        user_id: 1,
                        username: "johnsmith",
                        first_name: "John",
                        last_name: "Smith",
                        email: "john@example.com",
                        profile_picture: "https://randomuser.me/api/portraits/men/32.jpg",
                        is_admin: true
                    },
                    {
                        id: 2,
                        thread_id: threadId,
                        user_id: 2,
                        username: "supplierA",
                        first_name: "David",
                        last_name: "Johnson",
                        email: "david@supplier.com",
                        profile_picture: "https://randomuser.me/api/portraits/men/44.jpg",
                        is_admin: false
                    },
                    {
                        id: 3,
                        thread_id: threadId,
                        user_id: 3,
                        username: "sarahadmin",
                        first_name: "Sarah",
                        last_name: "Williams",
                        email: "sarah@example.com",
                        profile_picture: "https://randomuser.me/api/portraits/women/65.jpg",
                        is_admin: false
                    }
                ],
                messages: [
                    {
                        id: 101,
                        thread_id: threadId,
                        sender_id: 2,
                        recipient_id: 1,
                        content: "Hello, I'm interested in discussing the RFQ for industrial supplies. Can you provide more details about the specifications?",
                        created_at: "2025-05-02T10:35:00Z",
                        username: "David Johnson",
                        profile_picture: "https://randomuser.me/api/portraits/men/44.jpg"
                    },
                    {
                        id: 102,
                        thread_id: threadId,
                        sender_id: 1,
                        recipient_id: 2,
                        content: "Hi David, I'll attach the detailed specifications for the industrial supplies we're looking for. Please let me know if you have any questions.",
                        attachment_url: "/uploads/messages/specifications.pdf",
                        created_at: "2025-05-02T11:20:00Z"
                    },
                    {
                        id: 103,
                        thread_id: threadId,
                        sender_id: 2,
                        recipient_id: 1,
                        content: "Thank you for the specifications. We can definitely supply these items. Would you like to see samples before committing to a larger order?",
                        created_at: "2025-05-02T14:45:00Z",
                        username: "David Johnson",
                        profile_picture: "https://randomuser.me/api/portraits/men/44.jpg"
                    },
                    {
                        id: 104,
                        thread_id: threadId,
                        sender_id: 3,
                        recipient_id: 2,
                        content: "Hi, I'm Sarah from the procurement team. Yes, we would like to see samples for quality assessment before placing the bulk order.",
                        created_at: "2025-05-03T09:10:00Z",
                        username: "Sarah Williams",
                        profile_picture: "https://randomuser.me/api/portraits/women/65.jpg"
                    },
                    {
                        id: 105,
                        thread_id: threadId,
                        sender_id: 2,
                        recipient_id: 3,
                        content: "Great! I'll arrange for samples to be sent to your office. Could you please confirm the shipping address?",
                        created_at: "2025-05-03T09:30:00Z",
                        username: "David Johnson",
                        profile_picture: "https://randomuser.me/api/portraits/men/44.jpg"
                    },
                    {
                        id: 106,
                        thread_id: threadId,
                        sender_id: 1,
                        recipient_id: 2,
                        content: "Our shipping address is: 123 Business Park, Suite 456, Mumbai, India 400001. Please ensure the samples are labeled with our RFQ number.",
                        created_at: "2025-05-03T10:15:00Z"
                    },
                    {
                        id: 107,
                        thread_id: threadId,
                        sender_id: 2,
                        recipient_id: 1,
                        content: "Perfect! I've scheduled the samples to be shipped tomorrow. You should receive them within 3-5 business days.",
                        created_at: "2025-05-03T11:05:00Z",
                        username: "David Johnson",
                        profile_picture: "https://randomuser.me/api/portraits/men/44.jpg"
                    },
                    {
                        id: 108,
                        thread_id: threadId,
                        sender_id: 3,
                        recipient_id: 2,
                        content: "That's great news! Could you please provide the tracking information once available?",
                        created_at: "2025-05-03T13:40:00Z",
                        username: "Sarah Williams",
                        profile_picture: "https://randomuser.me/api/portraits/women/65.jpg"
                    },
                    {
                        id: 109,
                        thread_id: threadId,
                        sender_id: 2,
                        recipient_id: 3,
                        content: "Absolutely! I'll share the tracking details as soon as I have them.",
                        created_at: "2025-05-03T14:00:00Z",
                        username: "David Johnson",
                        profile_picture: "https://randomuser.me/api/portraits/men/44.jpg"
                    },
                    {
                        id: 110,
                        thread_id: threadId,
                        sender_id: 2,
                        recipient_id: 1,
                        content: "When can we expect delivery of the samples?",
                        created_at: "2025-05-03T14:15:00Z",
                        username: "David Johnson",
                        profile_picture: "https://randomuser.me/api/portraits/men/44.jpg"
                    }
                ]
            };
            
            return threadDetails;
        }
        
        function getSampleRelatedItems(type) {
            switch(type) {
                case 'rfq':
                    return [
                        { id: 1234, reference_number: 'RFQ-A7B4', title: 'Industrial Supplies Procurement' },
                        { id: 1235, reference_number: 'RFQ-B8C5', title: 'Electronic Components Order' },
                        { id: 1236, reference_number: 'RFQ-D9E6', title: 'Machinery Parts Sourcing' }
                    ];
                case 'bid':
                    return [
                        { id: 567, rfq_id: 1234, amount: 25000, status: 'Pending' },
                        { id: 568, rfq_id: 1235, amount: 18500, status: 'Accepted' },
                        { id: 569, rfq_id: 1236, amount: 42000, status: 'Under Review' }
                    ];
                case 'contract':
                    return [
                        { id: 789, title: 'Component Sourcing Agreement', status: 'Active' },
                        { id: 790, title: 'Machinery Maintenance Contract', status: 'Draft' },
                        { id: 791, title: 'Supply Chain Services', status: 'Completed' }
                    ];
                default:
                    return [];
            }
        }
        
        function getSampleUsers(query) {
            // Sample users for demonstration
            const allUsers = [
                { id: 2, username: 'davidj', first_name: 'David', last_name: 'Johnson', email: 'david@supplier.com', profile_picture: 'https://randomuser.me/api/portraits/men/44.jpg' },
                { id: 3, username: 'sarahw', first_name: 'Sarah', last_name: 'Williams', email: 'sarah@example.com', profile_picture: 'https://randomuser.me/api/portraits/women/65.jpg' },
                { id: 4, username: 'michaelb', first_name: 'Michael', last_name: 'Brown', email: 'michael@supplier.com', profile_picture: 'https://randomuser.me/api/portraits/men/22.jpg' },
                { id: 5, username: 'jennifert', first_name: 'Jennifer', last_name: 'Thompson', email: 'jennifer@company.com', profile_picture: 'https://randomuser.me/api/portraits/women/33.jpg' },
                { id: 6, username: 'robertp', first_name: 'Robert', last_name: 'Patel', email: 'robert@business.com', profile_picture: 'https://randomuser.me/api/portraits/men/82.jpg' }
            ];
            
            // Filter users based on query
            return allUsers.filter(user => {
                const searchStr = query.toLowerCase();
                return user.username.toLowerCase().includes(searchStr) || 
                       user.first_name.toLowerCase().includes(searchStr) || 
                       user.last_name.toLowerCase().includes(searchStr) || 
                       user.email.toLowerCase().includes(searchStr);
            });
        }
    </script>
</body>
</html>