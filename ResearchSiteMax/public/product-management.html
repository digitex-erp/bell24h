<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bell24h - Product Management</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .gradient-text {
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .gradient-bg {
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-2xl font-bold gradient-text">Bell24h</h1>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="/" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Home
                        </a>
                        <a href="#" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            RFQs
                        </a>
                        <a href="#" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Suppliers
                        </a>
                        <a href="/product-management.html" class="border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Products
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <h1 class="text-2xl font-semibold text-gray-900 mb-6">Product Management</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Product Form -->
                <div class="md:col-span-1 bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h2 class="text-lg font-medium text-gray-900 mb-4">Add New Product</h2>
                        <form id="productForm" class="space-y-4">
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border" required>
                            </div>
                            
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea id="description" name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border" required></textarea>
                            </div>
                            
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                                <select id="category" name="category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border" required>
                                    <option value="">Select Category</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Machinery">Machinery</option>
                                    <option value="Textiles">Textiles</option>
                                    <option value="Food & Beverages">Food & Beverages</option>
                                    <option value="Chemicals">Chemicals</option>
                                    <option value="Automotive">Automotive</option>
                                    <option value="Pharmaceuticals">Pharmaceuticals</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="price" class="block text-sm font-medium text-gray-700">Price</label>
                                <input type="number" id="price" name="price" min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border" required>
                            </div>
                            
                            <div>
                                <label for="priceUnit" class="block text-sm font-medium text-gray-700">Price Unit</label>
                                <select id="priceUnit" name="priceUnit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border" required>
                                    <option value="per_piece">Per Piece</option>
                                    <option value="per_kg">Per Kg</option>
                                    <option value="per_ton">Per Ton</option>
                                    <option value="per_liter">Per Liter</option>
                                    <option value="per_box">Per Box</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="minimumOrderQuantity" class="block text-sm font-medium text-gray-700">Minimum Order Quantity</label>
                                <input type="text" id="minimumOrderQuantity" name="minimumOrderQuantity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border">
                            </div>
                            
                            <div>
                                <label for="origin" class="block text-sm font-medium text-gray-700">Country of Origin</label>
                                <input type="text" id="origin" name="origin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border">
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="customizable" name="customizable" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="customizable" class="ml-2 block text-sm text-gray-700">Customizable</label>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="sampleAvailable" name="sampleAvailable" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="sampleAvailable" class="ml-2 block text-sm text-gray-700">Sample Available</label>
                            </div>
                            
                            <div>
                                <input type="hidden" id="supplierId" name="supplierId" value="1"> <!-- Default for testing -->
                                <input type="hidden" id="productId" name="productId" value=""> <!-- For updating -->
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white gradient-bg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Save Product
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Product List -->
                <div class="md:col-span-2 bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h2 class="text-lg font-medium text-gray-900 mb-4">Product List</h2>
                        <div class="mt-2">
                            <input type="text" id="searchInput" placeholder="Search products..." class="w-full p-2 border border-gray-300 rounded-md mb-4">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="productList" class="bg-white divide-y divide-gray-200">
                                    <!-- Products will be loaded here via JavaScript -->
                                    <tr>
                                        <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">Loading products...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const productForm = document.getElementById('productForm');
            const productList = document.getElementById('productList');
            const searchInput = document.getElementById('searchInput');
            let products = []; // To store all products
            
            // Load products on page load
            fetchProducts();
            
            // Event listeners
            productForm.addEventListener('submit', handleFormSubmit);
            searchInput.addEventListener('input', filterProducts);
            
            // Fetch products from API
            function fetchProducts() {
                // For demo purposes, using supplier ID 1
                const supplierId = 1;
                
                fetch(`/api/suppliers/${supplierId}/products`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch products');
                        }
                        return response.json();
                    })
                    .then(data => {
                        products = data || [];
                        renderProducts(products);
                    })
                    .catch(error => {
                        console.error('Error fetching products:', error);
                        // Show mock data for testing frontend if API fails
                        const mockProducts = [
                            { id: 1, name: 'Solar Panel Module', category: 'Electronics', price: 150.00, priceUnit: 'per_piece' },
                            { id: 2, name: 'Cotton Fabric', category: 'Textiles', price: 5.75, priceUnit: 'per_kg' },
                            { id: 3, name: 'Industrial Motor', category: 'Machinery', price: 320.50, priceUnit: 'per_piece' }
                        ];
                        products = mockProducts;
                        renderProducts(mockProducts);
                        productList.innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-sm text-red-500">
                                    Error loading products from API. Showing sample data for UI testing.
                                </td>
                            </tr>
                        ` + productList.innerHTML;
                    });
            }
            
            // Render products to the table
            function renderProducts(productsToRender) {
                if (productsToRender.length === 0) {
                    productList.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No products found</td>
                        </tr>
                    `;
                    return;
                }
                
                productList.innerHTML = productsToRender.map(product => `
                    <tr data-id="${product.id}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatPrice(product.price)} ${formatPriceUnit(product.priceUnit)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="editProduct(${product.id})" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                            <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Format price
            function formatPrice(price) {
                return parseFloat(price).toFixed(2);
            }
            
            // Format price unit
            function formatPriceUnit(unit) {
                if (!unit) return '';
                const unitMap = {
                    'per_piece': 'per piece',
                    'per_kg': 'per kg',
                    'per_ton': 'per ton',
                    'per_liter': 'per liter',
                    'per_box': 'per box'
                };
                return unitMap[unit] || unit;
            }
            
            // Handle form submission (create/update product)
            function handleFormSubmit(event) {
                event.preventDefault();
                
                const formData = new FormData(productForm);
                const productData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    category: formData.get('category'),
                    supplierId: parseInt(formData.get('supplierId')),
                    price: parseFloat(formData.get('price')),
                    priceUnit: formData.get('priceUnit'),
                    minimumOrderQuantity: formData.get('minimumOrderQuantity'),
                    origin: formData.get('origin'),
                    customizable: formData.get('customizable') === 'on',
                    sampleAvailable: formData.get('sampleAvailable') === 'on'
                };
                
                const productId = formData.get('productId');
                
                if (productId) {
                    // Update existing product
                    updateProduct(productId, productData);
                } else {
                    // Create new product
                    createProduct(productData);
                }
            }
            
            // Create new product
            function createProduct(productData) {
                fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to create product');
                    }
                    return response.json();
                })
                .then(data => {
                    alert('Product created successfully!');
                    productForm.reset();
                    fetchProducts(); // Refresh the list
                })
                .catch(error => {
                    console.error('Error creating product:', error);
                    alert('Failed to create product. Please try again.');
                    
                    // For demo purposes, simulate successful creation
                    productData.id = Date.now(); // Generate a fake ID
                    products.push(productData);
                    renderProducts(products);
                    productForm.reset();
                });
            }
            
            // Filter products based on search input
            function filterProducts() {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredProducts = products.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) || 
                    product.category.toLowerCase().includes(searchTerm)
                );
                renderProducts(filteredProducts);
            }
        });
        
        // Edit product (global function to be called from the table)
        function editProduct(productId) {
            // Fetch product details
            fetch(`/api/products/${productId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch product details');
                    }
                    return response.json();
                })
                .then(product => {
                    // Populate form with product details
                    document.getElementById('name').value = product.name;
                    document.getElementById('description').value = product.description;
                    document.getElementById('category').value = product.category;
                    document.getElementById('price').value = product.price;
                    document.getElementById('priceUnit').value = product.priceUnit;
                    document.getElementById('minimumOrderQuantity').value = product.minimumOrderQuantity || '';
                    document.getElementById('origin').value = product.origin || '';
                    document.getElementById('customizable').checked = product.customizable;
                    document.getElementById('sampleAvailable').checked = product.sampleAvailable;
                    document.getElementById('productId').value = product.id;
                    
                    // Scroll to form
                    document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    console.error('Error fetching product details:', error);
                    alert('Failed to load product details. Please try again.');
                });
        }
        
        // Update product
        function updateProduct(productId, productData) {
            fetch(`/api/products/${productId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(productData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update product');
                }
                return response.json();
            })
            .then(data => {
                alert('Product updated successfully!');
                document.getElementById('productForm').reset();
                document.getElementById('productId').value = '';
                // Refresh the list
                location.reload();
            })
            .catch(error => {
                console.error('Error updating product:', error);
                alert('Failed to update product. Please try again.');
            });
        }
        
        // Delete product
        function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }
            
            fetch(`/api/products/${productId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete product');
                }
                return response.json();
            })
            .then(data => {
                alert('Product deleted successfully!');
                // Remove the product from the table
                const row = document.querySelector(`tr[data-id="${productId}"]`);
                if (row) {
                    row.remove();
                }
            })
            .catch(error => {
                console.error('Error deleting product:', error);
                alert('Failed to delete product. Please try again.');
                
                // For demo purposes, simulate successful deletion
                const row = document.querySelector(`tr[data-id="${productId}"]`);
                if (row) {
                    row.remove();
                }
            });
        }
    </script>
</body>
</html>