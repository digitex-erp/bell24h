<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        #messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .message-form {
            display: flex;
            margin-bottom: 20px;
        }
        .message-form input {
            flex-grow: 1;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .message-form button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .message-form button:hover {
            background-color: #0069d9;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        .sent {
            background-color: #e6f3ff;
            text-align: right;
        }
        .received {
            background-color: #f5f5f5;
        }
        .event {
            font-style: italic;
            color: #6c757d;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>WebSocket Test</h1>
    
    <div id="status" class="disconnected">Disconnected</div>
    
    <h2>Messages</h2>
    <div id="messages"></div>
    
    <div class="message-form">
        <input type="text" id="user-id" placeholder="Your User ID" value="1">
        <button id="auth-button">Authenticate</button>
    </div>

    <div class="message-form">
        <input type="text" id="thread-id" placeholder="Thread ID" value="1">
        <input type="text" id="recipient-id" placeholder="Recipient ID" value="2">
        <button id="mark-read-button">Mark as Read</button>
    </div>
    
    <div class="message-form">
        <input type="text" id="message-input" placeholder="Type a message...">
        <button id="send-button" disabled>Send</button>
    </div>
    
    <div class="controls">
        <button id="reconnect-button">Reconnect</button>
        <button id="disconnect-button">Disconnect</button>
    </div>

    <script>
        // DOM elements
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const userIdInput = document.getElementById('user-id');
        const authButton = document.getElementById('auth-button');
        const threadIdInput = document.getElementById('thread-id');
        const recipientIdInput = document.getElementById('recipient-id');
        const markReadButton = document.getElementById('mark-read-button');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const reconnectButton = document.getElementById('reconnect-button');
        const disconnectButton = document.getElementById('disconnect-button');
        
        // WebSocket connection
        let socket = null;
        let authenticated = false;
        
        // Create WebSocket connection
        function connect() {
            // Close existing connection if any
            if (socket) {
                socket.close();
            }
            
            // Create new connection
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            addEventMessage(`Connecting to ${wsUrl}...`);
            
            socket = new WebSocket(wsUrl);
            
            // Connection opened
            socket.addEventListener('open', (event) => {
                statusEl.textContent = 'Connected';
                statusEl.className = 'connected';
                addEventMessage('Connection established');
            });
            
            // Listen for messages
            socket.addEventListener('message', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Message from server:', data);
                    
                    handleServerMessage(data);
                } catch (error) {
                    console.error('Error parsing message:', error);
                    addEventMessage(`Error: ${error.message}`);
                }
            });
            
            // Connection closed
            socket.addEventListener('close', (event) => {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'disconnected';
                authenticated = false;
                sendButton.disabled = true;
                addEventMessage('Connection closed');
            });
            
            // Connection error
            socket.addEventListener('error', (event) => {
                statusEl.textContent = 'Error';
                statusEl.className = 'disconnected';
                addEventMessage('Connection error');
                console.error('WebSocket error:', event);
            });
        }
        
        // Handle messages from server
        function handleServerMessage(data) {
            switch (data.type) {
                case 'unread_count':
                    addEventMessage(`You have ${data.count} unread messages`);
                    break;
                    
                case 'new_message':
                    addReceivedMessage(data.message);
                    break;
                    
                case 'error':
                    addEventMessage(`Error: ${data.message}`);
                    break;
                    
                default:
                    addEventMessage(`Received: ${JSON.stringify(data)}`);
            }
        }
        
        // Authenticate the WebSocket connection
        function authenticate() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addEventMessage('Cannot authenticate: not connected');
                return;
            }
            
            const userId = userIdInput.value.trim();
            
            if (!userId) {
                addEventMessage('Please enter a user ID');
                return;
            }
            
            socket.send(JSON.stringify({
                type: 'auth',
                userId: userId
            }));
            
            authenticated = true;
            sendButton.disabled = false;
            addEventMessage(`Authenticated as user ${userId}`);
        }
        
        // Mark thread as read
        function markAsRead() {
            if (!socket || socket.readyState !== WebSocket.OPEN || !authenticated) {
                addEventMessage('Cannot mark as read: not connected or not authenticated');
                return;
            }
            
            const threadId = threadIdInput.value.trim();
            
            if (!threadId) {
                addEventMessage('Please enter a thread ID');
                return;
            }
            
            socket.send(JSON.stringify({
                type: 'mark_read',
                threadId: parseInt(threadId)
            }));
            
            addEventMessage(`Marked thread ${threadId} as read`);
        }
        
        // Send message
        function sendMessage() {
            if (!socket || socket.readyState !== WebSocket.OPEN || !authenticated) {
                addEventMessage('Cannot send message: not connected or not authenticated');
                return;
            }
            
            const content = messageInput.value.trim();
            const threadId = threadIdInput.value.trim();
            const recipientId = recipientIdInput.value.trim();
            
            if (!content) {
                addEventMessage('Please enter a message');
                return;
            }
            
            if (!threadId) {
                addEventMessage('Please enter a thread ID');
                return;
            }
            
            if (!recipientId) {
                addEventMessage('Please enter a recipient ID');
                return;
            }
            
            const message = {
                threadId: parseInt(threadId),
                recipientId: parseInt(recipientId),
                content: content,
                attachmentUrl: null
            };
            
            socket.send(JSON.stringify({
                type: 'send_message',
                message: message
            }));
            
            // Add message to UI
            addSentMessage(content);
            
            // Clear input
            messageInput.value = '';
        }
        
        // Add sent message to messages
        function addSentMessage(content) {
            const messageEl = document.createElement('div');
            messageEl.className = 'message sent';
            messageEl.textContent = content;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // Add received message to messages
        function addReceivedMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'message received';
            
            let content = '';
            if (message.username) {
                content += `<strong>${message.username}:</strong> `;
            }
            content += message.content;
            
            messageEl.innerHTML = content;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // Add event message to messages
        function addEventMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'event';
            messageEl.textContent = message;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // Add event listeners
        authButton.addEventListener('click', authenticate);
        markReadButton.addEventListener('click', markAsRead);
        sendButton.addEventListener('click', sendMessage);
        reconnectButton.addEventListener('click', connect);
        disconnectButton.addEventListener('click', () => {
            if (socket) {
                socket.close();
            }
        });
        
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Initialize connection
        connect();
    </script>
</body>
</html>